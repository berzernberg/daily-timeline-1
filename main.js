/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
*/

var R=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var _=(S,o,t)=>o in S?R(S,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):S[o]=t;var Q=(S,o)=>{for(var t in o)R(S,t,{get:o[t],enumerable:!0})},q=(S,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of X(o))!U.call(S,i)&&i!==t&&R(S,i,{get:()=>o[i],enumerable:!(e=W(o,i))||e.enumerable});return S};var K=S=>q(R({},"__esModule",{value:!0}),S);var g=(S,o,t)=>_(S,typeof o!="symbol"?o+"":o,t);var J={};Q(J,{default:()=>z});module.exports=K(J);var V=require("obsidian");var O=require("obsidian");var F=class{static detectOverlaps(o){let t=o.filter(n=>n.isTimeRange),e=o.filter(n=>!n.isTimeRange),i=[];for(let n of t){if(!n.endHour||n.endMinute===void 0)continue;let a=n.hour*60+n.minute,r=n.endHour*60+n.endMinute,l=0;for(let c of e){let m=c.hour*60+c.minute;if(m>=a&&m<=r){l=1;break}}if(l===0)for(let c of t){if(c===n||!c.endHour||c.endMinute===void 0)continue;let m=c.hour*60+c.minute,d=c.endHour*60+c.endMinute;if(this.rangesOverlap(a,r,m,d)){l=1;break}}i.push({task:n,overlapLevel:l})}let s=i.sort((n,a)=>{let r=n.task.hour*60+n.task.minute,l=a.task.hour*60+a.task.minute;return r-l});for(let n=0;n<s.length;n++){let a=s[n];if(a.overlapLevel===0)continue;let r=a.task.hour*60+a.task.minute,l=(a.task.endHour||0)*60+(a.task.endMinute||0),c=0;for(let m=0;m<n;m++){let d=s[m];if(d.overlapLevel===0)continue;let u=d.task.hour*60+d.task.minute,h=(d.task.endHour||0)*60+(d.task.endMinute||0);this.rangesOverlap(r,l,u,h)&&(c=Math.max(c,d.overlapLevel))}a.overlapLevel=c+1}return s}static rangesOverlap(o,t,e,i){return o<i&&e<t}};var H="daily-notes-timeline",b={MIN:.7,MAX:10,DEFAULT:1,STEP:.5,BASE_SEGMENT_WIDTH:200},N=class extends O.ItemView{constructor(t,e){super(t);g(this,"plugin");g(this,"contentEl");g(this,"startDate");g(this,"endDate");g(this,"tooltips",[]);g(this,"zoomLevel",b.DEFAULT);g(this,"timelineScrollEl",null);g(this,"timelineContainerEl",null);g(this,"isDragging",!1);g(this,"dragStartX",0);g(this,"dragStartScrollLeft",0);g(this,"viewMode","month");g(this,"monthSelectEl",null);g(this,"quickRangeSelectEl",null);g(this,"startDateInputEl",null);g(this,"endDateInputEl",null);g(this,"customRangeContainerEl",null);g(this,"zoomSlider",null);g(this,"zoomLabel",null);this.plugin=e,this.viewMode=this.plugin.settings.viewMode;let i=new Date;this.viewMode==="custom"&&this.plugin.settings.customStartDate&&this.plugin.settings.customEndDate?(this.startDate=this.parseStoredDate(this.plugin.settings.customStartDate),this.endDate=this.parseStoredDate(this.plugin.settings.customEndDate)):(this.startDate=new Date(i.getFullYear(),i.getMonth(),1),this.endDate=new Date(i.getFullYear(),i.getMonth()+1,0))}parseStoredDate(t){let[e,i,s]=t.split("-").map(Number);return new Date(e,i-1,s)}formatDateForStorage(t){let e=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${i}-${s}`}formatDateForInput(t){return this.formatDateForStorage(t)}getRangeDurationInDays(){let t=Math.abs(this.endDate.getTime()-this.startDate.getTime());return Math.ceil(t/(1e3*60*60*24))+1}getViewType(){return H}getDisplayText(){return"Daily Notes Timeline"}getIcon(){return"calendar-clock"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("timeline-view-container"),this.contentEl=t.createDiv({cls:"timeline-content"}),await this.renderControls(),await this.renderTimeline()}async onClose(){this.cleanupTooltips(),this.contentEl.empty()}cleanupTooltips(){for(let t of this.tooltips)t.remove();this.tooltips=[]}async renderControls(){let t=this.contentEl.createDiv({cls:"timeline-controls"}),e=t.createDiv({cls:"timeline-controls-left"}),i=t.createDiv({cls:"timeline-controls-center"}),s=t.createDiv({cls:"timeline-controls-right"});this.renderModeSelector(s),this.renderMonthControls(s),this.renderCustomRangeControls(s),this.updateControlsVisibility(),e.createEl("button",{text:"\u2190 Previous",cls:"mod-cta"}).addEventListener("click",async()=>{await this.navigatePrevious()}),e.createEl("button",{text:"Next \u2192",cls:"mod-cta"}).addEventListener("click",async()=>{await this.navigateNext()}),e.createEl("button",{text:"Today",cls:"mod-cta"}).addEventListener("click",async()=>{await this.navigateToToday()}),this.renderZoomControls(i)}renderModeSelector(t){let i=t.createDiv({cls:"timeline-mode-selector"}).createEl("select",{cls:"dropdown timeline-mode-select"}),s=i.createEl("option",{value:"month",text:"Month View"}),n=i.createEl("option",{value:"custom",text:"Custom Range"});i.value=this.viewMode,i.addEventListener("change",async()=>{if(this.viewMode=i.value,this.plugin.settings.viewMode=this.viewMode,await this.plugin.saveSettings(),this.updateControlsVisibility(),this.viewMode==="month"){let a=new Date;this.startDate=new Date(a.getFullYear(),a.getMonth(),1),this.endDate=new Date(a.getFullYear(),a.getMonth()+1,0),this.monthSelectEl&&await this.updateMonthSelect(this.monthSelectEl)}await this.renderTimeline()})}renderMonthControls(t){let i=t.createDiv({cls:"timeline-month-controls"}).createEl("select",{cls:"dropdown timeline-month-select"});this.monthSelectEl=i,this.populateMonthSelect(i),i.addEventListener("change",async()=>{let[s,n]=i.value.split("-").map(Number);this.startDate=new Date(s,n,1),this.endDate=new Date(s,n+1,0),this.zoomLevel=b.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()})}renderCustomRangeControls(t){let e=t.createDiv({cls:"timeline-custom-range-controls"});this.customRangeContainerEl=e;let i=e.createEl("select",{cls:"dropdown timeline-quick-range-select"});this.quickRangeSelectEl=i,[{value:"last7days",label:"Last 7 Days"},{value:"last30days",label:"Last 30 Days"},{value:"thisweek",label:"This Week"},{value:"thismonth",label:"This Month"},{value:"last3months",label:"Last 3 Months"},{value:"custom",label:"Custom"}].forEach(m=>{i.createEl("option",{value:m.value,text:m.label})}),i.value=this.plugin.settings.lastQuickRangePreset,i.addEventListener("change",async()=>{let m=i.value;this.plugin.settings.lastQuickRangePreset=m,await this.plugin.saveSettings(),m!=="custom"&&this.applyQuickRangePreset(m)});let n=e.createDiv({cls:"timeline-date-inputs"}),a=n.createSpan({cls:"timeline-date-label",text:"From:"}),r=n.createEl("input",{type:"date",cls:"timeline-date-input"});this.startDateInputEl=r,r.value=this.formatDateForInput(this.startDate);let l=n.createSpan({cls:"timeline-date-label",text:"To:"}),c=n.createEl("input",{type:"date",cls:"timeline-date-input"});this.endDateInputEl=c,c.value=this.formatDateForInput(this.endDate),r.addEventListener("change",async()=>{await this.handleCustomDateChange()}),c.addEventListener("change",async()=>{await this.handleCustomDateChange()})}async handleCustomDateChange(){if(!this.startDateInputEl||!this.endDateInputEl)return;let t=this.startDateInputEl.value,e=this.endDateInputEl.value;if(!t||!e)return;let i=new Date(t),s=new Date(e);if(s<i){alert("End date must be after or equal to start date"),this.startDateInputEl.value=this.formatDateForInput(this.startDate),this.endDateInputEl.value=this.formatDateForInput(this.endDate);return}if(Math.ceil((s.getTime()-i.getTime())/(1e3*60*60*24))>365){alert("Date range cannot exceed 365 days"),this.startDateInputEl.value=this.formatDateForInput(this.startDate),this.endDateInputEl.value=this.formatDateForInput(this.endDate);return}this.startDate=i,this.endDate=s,this.plugin.settings.customStartDate=this.formatDateForStorage(this.startDate),this.plugin.settings.customEndDate=this.formatDateForStorage(this.endDate),await this.plugin.saveSettings(),this.quickRangeSelectEl&&(this.quickRangeSelectEl.value="custom",this.plugin.settings.lastQuickRangePreset="custom",await this.plugin.saveSettings()),this.zoomLevel=b.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()}applyQuickRangePreset(t){let e=new Date;switch(e.setHours(0,0,0,0),t){case"last7days":this.endDate=new Date(e),this.startDate=new Date(e),this.startDate.setDate(this.startDate.getDate()-6);break;case"last30days":this.endDate=new Date(e),this.startDate=new Date(e),this.startDate.setDate(this.startDate.getDate()-29);break;case"thisweek":let i=e.getDay();this.startDate=new Date(e),this.startDate.setDate(this.startDate.getDate()-i),this.endDate=new Date(this.startDate),this.endDate.setDate(this.endDate.getDate()+6);break;case"thismonth":this.startDate=new Date(e.getFullYear(),e.getMonth(),1),this.endDate=new Date(e.getFullYear(),e.getMonth()+1,0);break;case"last3months":this.endDate=new Date(e),this.startDate=new Date(e),this.startDate.setMonth(this.startDate.getMonth()-3);break}this.startDateInputEl&&this.endDateInputEl&&(this.startDateInputEl.value=this.formatDateForInput(this.startDate),this.endDateInputEl.value=this.formatDateForInput(this.endDate)),this.plugin.settings.customStartDate=this.formatDateForStorage(this.startDate),this.plugin.settings.customEndDate=this.formatDateForStorage(this.endDate),this.plugin.saveSettings(),this.zoomLevel=b.DEFAULT,this.renderTimeline(),this.updateZoomSlider()}updateControlsVisibility(){this.monthSelectEl&&this.monthSelectEl.parentElement&&(this.viewMode==="month"?this.monthSelectEl.parentElement.style.display="":this.monthSelectEl.parentElement.style.display="none"),this.customRangeContainerEl&&(this.viewMode==="custom"?this.customRangeContainerEl.style.display="":this.customRangeContainerEl.style.display="none")}async navigatePrevious(){if(this.viewMode==="month")this.startDate=new Date(this.startDate.getFullYear(),this.startDate.getMonth()-1,1),this.endDate=new Date(this.endDate.getFullYear(),this.endDate.getMonth(),0),this.monthSelectEl&&await this.updateMonthSelect(this.monthSelectEl);else{let t=this.getRangeDurationInDays();this.startDate.setDate(this.startDate.getDate()-t),this.endDate.setDate(this.endDate.getDate()-t),this.startDateInputEl&&this.endDateInputEl&&(this.startDateInputEl.value=this.formatDateForInput(this.startDate),this.endDateInputEl.value=this.formatDateForInput(this.endDate)),this.plugin.settings.customStartDate=this.formatDateForStorage(this.startDate),this.plugin.settings.customEndDate=this.formatDateForStorage(this.endDate),await this.plugin.saveSettings(),this.quickRangeSelectEl&&(this.quickRangeSelectEl.value="custom")}this.zoomLevel=b.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()}async navigateNext(){if(this.viewMode==="month")this.startDate=new Date(this.startDate.getFullYear(),this.startDate.getMonth()+1,1),this.endDate=new Date(this.endDate.getFullYear(),this.endDate.getMonth()+2,0),this.monthSelectEl&&await this.updateMonthSelect(this.monthSelectEl);else{let t=this.getRangeDurationInDays();this.startDate.setDate(this.startDate.getDate()+t),this.endDate.setDate(this.endDate.getDate()+t),this.startDateInputEl&&this.endDateInputEl&&(this.startDateInputEl.value=this.formatDateForInput(this.startDate),this.endDateInputEl.value=this.formatDateForInput(this.endDate)),this.plugin.settings.customStartDate=this.formatDateForStorage(this.startDate),this.plugin.settings.customEndDate=this.formatDateForStorage(this.endDate),await this.plugin.saveSettings(),this.quickRangeSelectEl&&(this.quickRangeSelectEl.value="custom")}this.zoomLevel=b.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()}async navigateToToday(){this.viewMode="month",this.plugin.settings.viewMode="month",await this.plugin.saveSettings();let t=new Date;this.startDate=new Date(t.getFullYear(),t.getMonth(),1),this.endDate=new Date(t.getFullYear(),t.getMonth()+1,0),this.updateControlsVisibility(),this.monthSelectEl&&await this.updateMonthSelect(this.monthSelectEl);let e=this.contentEl.querySelector(".timeline-mode-select");e&&(e.value="month"),this.zoomLevel=b.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()}renderZoomControls(t){let e=t.createDiv({cls:"timeline-zoom-controls"}),i=e.createEl("button",{cls:"timeline-zoom-button",attr:{"aria-label":"Zoom out"}});i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path><line x1="8" y1="11" x2="14" y2="11"></line></svg>',i.addEventListener("click",()=>{let l=Math.max(b.MIN,this.zoomLevel-b.STEP);this.applyZoom(l)});let s=e.createDiv({cls:"timeline-zoom-slider-container"}),n=s.createEl("input",{type:"range",cls:"timeline-zoom-slider"});n.min=String(b.MIN*100),n.max=String(b.MAX*100),n.value=String(this.zoomLevel*100),n.step=String(b.STEP*100);let a=s.createDiv({cls:"timeline-zoom-label"});a.setText(`${Math.round(this.zoomLevel*100)}%`);let r=e.createEl("button",{cls:"timeline-zoom-button",attr:{"aria-label":"Zoom in"}});r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>',r.addEventListener("click",()=>{let l=Math.min(b.MAX,this.zoomLevel+b.STEP);this.applyZoom(l)}),n.addEventListener("input",()=>{let l=parseFloat(n.value)/100;a.setText(`${Math.round(l*100)}%`)}),n.addEventListener("change",()=>{let l=parseFloat(n.value)/100;this.applyZoom(l)}),this.zoomSlider=n,this.zoomLabel=a}updateZoomSlider(){this.zoomSlider&&(this.zoomSlider.value=String(this.zoomLevel*100)),this.zoomLabel&&this.zoomLabel.setText(`${Math.round(this.zoomLevel*100)}%`)}applyZoom(t,e){if(!this.timelineContainerEl)return;let i=this.timelineContainerEl,s=i.scrollLeft,n=i.clientWidth,a=i.scrollWidth,r;e!==void 0?r=s+e:r=s+n/2;let l=r/a;this.zoomLevel=t,this.updateZoomSlider(),this.renderTimeline().then(()=>{if(!this.timelineContainerEl)return;let c=this.timelineContainerEl.scrollWidth,m=l*c,d=e!==void 0?m-e:m-n/2;this.timelineContainerEl.scrollLeft=Math.max(0,d)})}setupTimelineInteractions(t){t.addEventListener("wheel",s=>{if(s.ctrlKey||s.metaKey){s.preventDefault();let n=t.getBoundingClientRect(),a=s.clientX-n.left,l=-s.deltaY>0?b.STEP:-b.STEP,c=Math.max(b.MIN,Math.min(b.MAX,this.zoomLevel+l));this.applyZoom(c,a)}else s.preventDefault(),t.scrollLeft+=s.deltaY}),t.addEventListener("mousedown",s=>{if(s.button!==0)return;let n=s.target;n.closest(".timeline-task")||n.closest("a")||(s.preventDefault(),this.isDragging=!0,this.dragStartX=s.clientX,this.dragStartScrollLeft=t.scrollLeft,t.style.cursor="grabbing",t.style.userSelect="none")});let e=s=>{if(!this.isDragging||!this.timelineContainerEl)return;s.preventDefault();let n=s.clientX-this.dragStartX;this.timelineContainerEl.scrollLeft=this.dragStartScrollLeft-n},i=()=>{this.isDragging&&this.timelineContainerEl&&(this.isDragging=!1,this.timelineContainerEl.style.cursor="grab",this.timelineContainerEl.style.userSelect="")};document.addEventListener("mousemove",e),document.addEventListener("mouseup",i),t.addEventListener("mouseleave",()=>{this.isDragging&&this.timelineContainerEl&&(this.isDragging=!1,this.timelineContainerEl.style.cursor="grab",this.timelineContainerEl.style.userSelect="")})}async populateMonthSelect(t){let e=await this.plugin.parser.getAvailableMonths(this.plugin.settings.dailyNotesFolder,this.plugin.settings.dateFormat);t.empty();for(let i of e){let[s,n]=i.split("-").map(Number),a=new Date(s,n,1),r=t.createEl("option");r.value=i,r.text=a.toLocaleDateString("en-US",{year:"numeric",month:"long"}),s===this.startDate.getFullYear()&&n===this.startDate.getMonth()&&(r.selected=!0)}}async updateMonthSelect(t){t.value=`${this.startDate.getFullYear()}-${this.startDate.getMonth()}`}async renderTimeline(){this.cleanupTooltips();let t=this.contentEl.querySelector(".timeline-scroll");t&&t.remove();let e=this.contentEl.createDiv({cls:"timeline-scroll"});this.timelineScrollEl=e;let i=await this.plugin.parser.parseDailyNotes(this.plugin.settings.dailyNotesFolder,this.plugin.settings.dateFormat,this.startDate,this.endDate);if(i.length===0){e.createDiv({cls:"timeline-empty",text:"No date range selected"});return}await this.renderContinuousTimeline(e,i)}async renderContinuousTimeline(t,e){let i=t.createDiv({cls:"timeline-continuous"});this.timelineContainerEl=i,this.setupTimelineInteractions(i);let s=i.createDiv({cls:"timeline-track-continuous"}),n=b.BASE_SEGMENT_WIDTH*this.zoomLevel,a=n*e.length;s.style.width=`${a}px`;for(let r=0;r<e.length;r++){let l=e[r];await this.renderDaySegment(s,l,r,e.length,n)}}groupOverlappingTasks(t,e){if(t.length===0)return[];if(!this.plugin.settings.enableGrouping)return t;let s=[...t.filter(c=>!c.isTimeRange)].sort((c,m)=>{let d=c.hour*60+c.minute,u=m.hour*60+m.minute;return d-u}),n=this.plugin.settings.minSpacingPixels,a=this.plugin.settings.maxGroupSpanPixels,r=[],l=[s[0]];for(let c=1;c<s.length;c++){let m=s[c-1],d=s[c],u=(m.hour*60+m.minute)/1440*100,h=(d.hour*60+d.minute)/1440*100,p=Math.abs(h-u)*(e/100),D=(l[0].hour*60+l[0].minute)/1440*100,f=Math.abs(h-D)*(e/100);if(p<n&&f<a)l.push(d);else{if(l.length>1){let v=l.reduce((C,P)=>C+(P.hour*60+P.minute),0)/l.length,T=v/1440*100,E=Math.floor(v/60),y=Math.floor(v%60);r.push({tasks:l,position:T,averageTime:`${String(E).padStart(2,"0")}:${String(y).padStart(2,"0")}`})}else r.push(l[0]);l=[d]}}if(l.length>1){let c=l.reduce((h,p)=>h+(p.hour*60+p.minute),0)/l.length,m=c/1440*100,d=Math.floor(c/60),u=Math.floor(c%60);r.push({tasks:l,position:m,averageTime:`${String(d).padStart(2,"0")}:${String(u).padStart(2,"0")}`})}else r.push(l[0]);return r}async renderDaySegment(t,e,i,s,n){let a=t.createDiv({cls:"timeline-segment"});a.style.width=`${n}px`,a.style.left=`${n*i}px`,e.tasks.length===0&&a.addClass("timeline-segment-empty");let r=new Date(e.date),l=a.createDiv({cls:"timeline-segment-date"});l.setText(r.toLocaleDateString("en-US",{month:"short",day:"numeric"})),e.path&&(l.addClass("timeline-segment-date-clickable"),l.addEventListener("click",async p=>{p.preventDefault();let D=this.app.vault.getAbstractFileByPath(e.path);D&&await this.app.workspace.getLeaf(!1).openFile(D)})),a.createDiv({cls:"timeline-segment-weekday"}).setText(r.toLocaleDateString("en-US",{weekday:"short"})),a.createDiv({cls:"timeline-segment-time timeline-segment-time-start"}).setText("00:00"),a.createDiv({cls:"timeline-segment-time timeline-segment-time-end"}).setText("23:59");let u=this.groupOverlappingTasks(e.tasks,n);for(let p of u)"tasks"in p?await this.renderGroupedTaskInSegment(a,p):await this.renderTaskInSegment(a,p);let h=F.detectOverlaps(e.tasks);for(let p of h)await this.renderTimeRangeInSegment(a,p,n)}getTagStyle(t){return t?this.plugin.settings.tagStyles.find(e=>e.tag===t):null}async renderGroupedTaskInSegment(t,e){let i=t.createDiv({cls:"timeline-task-dot-container timeline-task-grouped"}),s=Math.min(e.position,96);i.style.left=`${s}%`;let n=i.createDiv({cls:"timeline-task-dot"});n.setAttribute("data-status","grouped"),n.createDiv({cls:"timeline-task-count-badge"}).setText(String(e.tasks.length));let r=i.createDiv({cls:"timeline-emoji-stack"}),l=new Set;for(let d of e.tasks){let u=this.getTagStyle(d.firstTag);u&&u.emoji?l.add(u.emoji):d.hasAttachment&&!l.has("\u{1F4F8}")&&l.add("\u{1F4F8}")}l.forEach(d=>{r.createDiv({cls:"timeline-task-emoji"}).setText(d)});let c=document.body.createDiv({cls:"timeline-tooltip"});this.tooltips.push(c);let m=c.createDiv({cls:"timeline-tooltip-wrapper"});for(let d=0;d<e.tasks.length;d++){let u=e.tasks[d],h=m.createDiv({cls:"timeline-tooltip-content"});d>0&&h.addClass("timeline-tooltip-stacked");let p=h.createDiv({cls:"timeline-tooltip-time"}),D=this.getTagStyle(u.firstTag);D&&D.emoji&&p.createSpan({cls:"timeline-tooltip-time-emoji"}).setText(D.emoji),p.createSpan().setText(u.time);let v=h.createDiv({cls:"timeline-tooltip-task"});if(v.textContent=`[${u.status}] `,await this.renderTaskContent(v,u.content),u.subItems.length>0){let T=h.createEl("ul",{cls:"timeline-tooltip-subitems"});for(let E of u.subItems){let y=T.createEl("li");await this.renderTaskContent(y,E)}}}i.addEventListener("mouseenter",()=>{let d=i.getBoundingClientRect(),u=window.innerHeight,h=e.tasks.length*120,p=d.bottom+12,D=d.left+d.width/2,f="translateX(-50%)",v=!1;p+h>u-20&&u-p-20<200&&(p=d.top-Math.min(h,u*.6)-12,v=!0,p<20&&(p=20));let T=Math.min(u*.7,h);m.style.maxHeight=`${T}px`,v?c.addClass("tooltip-above"):c.removeClass("tooltip-above"),c.style.top=`${p}px`,c.style.left=`${D}px`,c.style.transform=f,c.addClass("is-visible"),i.addClass("is-hovered")}),i.addEventListener("mouseleave",()=>{c.removeClass("is-visible"),c.removeClass("tooltip-above"),i.removeClass("is-hovered")}),c.addEventListener("mouseenter",()=>{c.addClass("is-visible"),i.addClass("is-hovered")}),c.addEventListener("mouseleave",()=>{c.removeClass("is-visible"),c.removeClass("tooltip-above"),i.removeClass("is-hovered")})}async renderTaskInSegment(t,e){let s=(e.hour*60+e.minute)/1440*100;s=Math.min(s,96);let n=t.createDiv({cls:"timeline-task-dot-container"});n.style.left=`${s}%`;let a=n.createDiv({cls:"timeline-task-dot"});a.setAttribute("data-status",e.status);let r=this.getTagStyle(e.firstTag);r&&r.color&&(a.addClass("timeline-task-dot-custom"),a.style.setProperty("background-color",r.color,"important")),a.createDiv({cls:"timeline-task-label"}).setText(e.time);let c=n.createDiv({cls:"timeline-emoji-stack"});r&&r.emoji?c.createDiv({cls:"timeline-task-emoji"}).setText(r.emoji):e.hasAttachment&&c.createDiv({cls:"timeline-task-emoji"}).setText("\u{1F4F8}");let m=document.body.createDiv({cls:"timeline-tooltip"});this.tooltips.push(m);let d=m.createDiv({cls:"timeline-tooltip-content"}),u=d.createDiv({cls:"timeline-tooltip-time"});r&&r.emoji&&u.createSpan({cls:"timeline-tooltip-time-emoji"}).setText(r.emoji),u.createSpan().setText(e.time);let p=d.createDiv({cls:"timeline-tooltip-task"});if(p.textContent=`[${e.status}] `,await this.renderTaskContent(p,e.content),e.subItems.length>0){let D=d.createEl("ul",{cls:"timeline-tooltip-subitems"});for(let f of e.subItems){let v=D.createEl("li");await this.renderTaskContent(v,f)}}n.addEventListener("mouseenter",()=>{let D=n.getBoundingClientRect(),f=window.innerHeight,v=D.bottom+12;setTimeout(()=>{let T=m.offsetHeight;v+T>f-20?(v=D.top-T-12,m.addClass("tooltip-above"),v<20&&(v=20)):m.removeClass("tooltip-above"),m.style.top=`${v}px`},0),m.style.top=`${v}px`,m.style.left=`${D.left+D.width/2}px`,m.style.transform="translateX(-50%)",m.addClass("is-visible"),n.addClass("is-hovered")}),n.addEventListener("mouseleave",()=>{m.removeClass("is-visible"),m.removeClass("tooltip-above"),n.removeClass("is-hovered")}),m.addEventListener("mouseenter",()=>{m.addClass("is-visible"),n.addClass("is-hovered")}),m.addEventListener("mouseleave",()=>{m.removeClass("is-visible"),m.removeClass("tooltip-above"),n.removeClass("is-hovered")})}async renderTaskContent(t,e){let i=/(!\[\[([^\]]+)\]\])|(\[\[([^\]]+)\]\])/g,s=0,n;for(;(n=i.exec(e))!==null;){if(n.index>s&&await this.renderTextWithLinks(t,e.substring(s,n.index)),n[1]){let a=n[2];await this.renderImage(t,a)}else if(n[3]){let a=n[4];this.renderLink(t,a)}s=n.index+n[0].length}s<e.length&&await this.renderTextWithLinks(t,e.substring(s))}async renderTextWithLinks(t,e){let i=/#([\p{L}\p{N}_\/-]+)/gu,s=0,n;for(;(n=i.exec(e))!==null;){if(n.index>s){let l=t.createSpan();l.textContent=e.substring(s,n.index)}let a=n[1],r=t.createEl("a",{cls:"tag timeline-tooltip-tag",href:"#"});r.textContent=`#${a}`,r.addEventListener("click",async l=>{var c;l.preventDefault(),(c=this.app.internalPlugins.getPluginById("global-search"))==null||c.instance.openGlobalSearch(`tag:#${a}`)}),s=n.index+n[0].length}if(s<e.length){let a=t.createSpan();a.textContent=e.substring(s)}}renderLink(t,e){let i=e.split("|"),s=i[0].trim(),n=i.length>1?i[1].trim():s,a=t.createEl("a",{cls:"internal-link timeline-tooltip-link",href:"#"});a.textContent=n,a.addEventListener("click",async r=>{r.preventDefault();let l=this.plugin.app.metadataCache.getFirstLinkpathDest(s,"");l&&await this.plugin.app.workspace.getLeaf(!1).openFile(l)})}async renderTimeRangeInSegment(t,e,i){let s=e.task;if(!s.endHour||s.endMinute===void 0)return;let n=s.hour*60+s.minute,a=s.endHour*60+s.endMinute,r=Math.min(n/1440*100,96),c=Math.min(a/1440*100,100)-r,m=t.createDiv({cls:"timeline-range-container"});m.style.left=`${r}%`,m.style.width=`${c}%`;let d=e.overlapLevel===0?0:e.overlapLevel*40;m.style.bottom=`calc(50% + ${d}px)`,m.setAttribute("data-overlap-level",String(e.overlapLevel));let u=m.createDiv({cls:"timeline-range-line"});u.setAttribute("data-status",s.status);let h=this.getTagStyle(s.firstTag);h&&h.color&&(u.addClass("timeline-range-line-custom"),u.style.setProperty("background-color",h.color,"important"));let p=c/100*i,D=`${s.time} - ${s.timeEnd}`,f=D.length*6,v=p>=f+10,T;v?(T=u.createDiv({cls:"timeline-range-label timeline-range-label-inside"}),T.setText(D)):(T=m.createDiv({cls:"timeline-range-label timeline-range-label-outside"}),T.setText(D));let E=m.createDiv({cls:"timeline-range-emoji"});h&&h.emoji?E.createDiv({cls:"timeline-task-emoji"}).setText(h.emoji):s.hasAttachment&&E.createDiv({cls:"timeline-task-emoji"}).setText("\u{1F4F8}");let y=document.body.createDiv({cls:"timeline-tooltip"});this.tooltips.push(y);let C=y.createDiv({cls:"timeline-tooltip-content"}),P=C.createDiv({cls:"timeline-tooltip-time"});h&&h.emoji&&P.createSpan({cls:"timeline-tooltip-time-emoji"}).setText(h.emoji),P.createSpan().setText(`${s.time} - ${s.timeEnd}`);let M=C.createDiv({cls:"timeline-tooltip-task"});if(M.textContent=`[${s.status}] `,await this.renderTaskContent(M,s.content),s.subItems.length>0){let L=C.createEl("ul",{cls:"timeline-tooltip-subitems"});for(let x of s.subItems){let I=L.createEl("li");await this.renderTaskContent(I,x)}}m.addEventListener("mouseenter",()=>{let L=m.getBoundingClientRect(),x=window.innerHeight,I=L.bottom+12;setTimeout(()=>{let G=y.offsetHeight;I+G>x-20?(I=L.top-G-12,y.addClass("tooltip-above"),I<20&&(I=20)):y.removeClass("tooltip-above"),y.style.top=`${I}px`},0),y.style.top=`${I}px`,y.style.left=`${L.left+L.width/2}px`,y.style.transform="translateX(-50%)",y.addClass("is-visible"),m.addClass("is-hovered")}),m.addEventListener("mouseleave",()=>{y.removeClass("is-visible"),y.removeClass("tooltip-above"),m.removeClass("is-hovered")}),y.addEventListener("mouseenter",()=>{y.addClass("is-visible"),m.addClass("is-hovered")}),y.addEventListener("mouseleave",()=>{y.removeClass("is-visible"),y.removeClass("tooltip-above"),m.removeClass("is-hovered")})}async renderImage(t,e){let i=this.plugin.app.vault.getAbstractFileByPath(e);if(i&&i instanceof this.plugin.app.vault.adapter.constructor){let n=t.createDiv({cls:"timeline-tooltip-image"}).createEl("img"),a=this.plugin.app.vault.getResourcePath(i);n.src=a,n.alt=e}else{let n=this.plugin.app.vault.getFiles().find(a=>a.name===e||a.path.endsWith(e));if(n){let r=t.createDiv({cls:"timeline-tooltip-image"}).createEl("img"),l=this.plugin.app.vault.getResourcePath(n);r.src=l,r.alt=e}}}};var k=require("obsidian");var $=class extends k.PluginSettingTab{constructor(t,e){super(t,e);g(this,"plugin");this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Daily Notes Timeline Settings"}),new k.Setting(t).setName("Daily Notes Folder").setDesc("Path to your daily notes folder (leave empty for vault root or default daily notes location)").addText(e=>e.setPlaceholder("Daily Notes").setValue(this.plugin.settings.dailyNotesFolder).onChange(async i=>{this.plugin.settings.dailyNotesFolder=i,await this.plugin.saveSettings()})),new k.Setting(t).setName("Date Format").setDesc("Format used in daily note filenames (e.g., YYYY-MM-DD)").addText(e=>e.setPlaceholder("YYYY-MM-DD").setValue(this.plugin.settings.dateFormat).onChange(async i=>{this.plugin.settings.dateFormat=i,await this.plugin.saveSettings()})),new k.Setting(t).setName("Default Timeline Range").setDesc("Number of months to display by default").addSlider(e=>e.setLimits(1,12,1).setValue(this.plugin.settings.defaultRangeMonths).setDynamicTooltip().onChange(async i=>{this.plugin.settings.defaultRangeMonths=i,await this.plugin.saveSettings()})),t.createEl("h2",{text:"Tag Styles"}),t.createEl("p",{text:"Customize the appearance of timeline points based on the first hashtag in each task.",cls:"setting-item-description"}),this.displayTagStylesList(t),this.displayAddTagStyleForm(t),this.displayGroupingSettings(t)}displayGroupingSettings(t){t.createEl("h2",{text:"Points Grouping"}),t.createEl("p",{text:"Configure how timeline points are grouped when they appear close together. Grouping helps reduce visual clutter by combining nearby tasks into a single point with a count badge.",cls:"setting-item-description"}),new k.Setting(t).setName("Enable Grouping").setDesc("When enabled, tasks that appear close together on the timeline will be automatically grouped").addToggle(e=>e.setValue(this.plugin.settings.enableGrouping).onChange(async i=>{this.plugin.settings.enableGrouping=i,await this.plugin.saveSettings()})),new k.Setting(t).setName("Minimum Spacing").setDesc("Minimum distance (in pixels) between tasks before they are grouped together. Lower values create more groups.").addSlider(e=>e.setLimits(10,100,5).setValue(this.plugin.settings.minSpacingPixels).setDynamicTooltip().onChange(async i=>{this.plugin.settings.minSpacingPixels=i,await this.plugin.saveSettings()})),new k.Setting(t).setName("Maximum Group Span").setDesc("Maximum distance (in pixels) between the first and last task in a group. Prevents overly large groups.").addSlider(e=>e.setLimits(30,150,10).setValue(this.plugin.settings.maxGroupSpanPixels).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxGroupSpanPixels=i,await this.plugin.saveSettings()})),new k.Setting(t).addButton(e=>e.setButtonText("Reset to Defaults").setTooltip("Restore default grouping settings").onClick(async()=>{this.plugin.settings.enableGrouping=!0,this.plugin.settings.minSpacingPixels=25,this.plugin.settings.maxGroupSpanPixels=60,await this.plugin.saveSettings(),this.display()}))}displayTagStylesList(t){let e=t.createDiv({cls:"tag-styles-list"});if(this.plugin.settings.tagStyles.length===0){e.createEl("p",{text:"No tag styles configured yet. Add one below.",cls:"setting-item-description"});return}this.plugin.settings.tagStyles.forEach((i,s)=>{let n=e.createDiv({cls:"tag-style-preset"}),a=n.createDiv({cls:"tag-style-info"}),r=a.createDiv({cls:"tag-style-color-swatch"});r.style.backgroundColor=i.color,a.createSpan({cls:"tag-style-tag-name"}).setText(`#${i.tag}`),i.emoji&&a.createSpan({cls:"tag-style-emoji-preview"}).setText(i.emoji);let c=n.createDiv({cls:"tag-style-actions"});c.createEl("button",{text:"Edit",cls:"mod-cta"}).addEventListener("click",()=>{this.editTagStyle(s,i)}),c.createEl("button",{text:"Delete",cls:"mod-warning"}).addEventListener("click",async()=>{this.plugin.settings.tagStyles.splice(s,1),await this.plugin.saveSettings(),this.display()})})}displayAddTagStyleForm(t){t.createEl("h3",{text:"Add New Tag Style"});let e=t.createDiv({cls:"tag-style-form"}),i,s,n;new k.Setting(e).setName("Tag Name").setDesc("Enter tag name without the # symbol (e.g., 'log' for #log, or 'log/work' for #log/work)").addText(a=>{i=a.inputEl,a.setPlaceholder("log/work")}),new k.Setting(e).setName("Color").setDesc("Choose a color for the timeline point").addColorPicker(a=>{s=a.colorPickerEl,a.setValue("#3b82f6")}),new k.Setting(e).setName("Emoji (Optional)").setDesc("Enter an emoji to display below the timeline point").addText(a=>{n=a.inputEl,a.setPlaceholder("\u{1F4DD}")}),new k.Setting(e).addButton(a=>a.setButtonText("Add Style").setCta().onClick(async()=>{let r=i.value.trim().toLowerCase(),l=s.value,c=n.value.trim();if(!r){alert("Please enter a tag name");return}if(this.plugin.settings.tagStyles.some(m=>m.tag===r)){alert(`A style for tag "${r}" already exists`);return}this.plugin.settings.tagStyles.push({tag:r,color:l,emoji:c}),await this.plugin.saveSettings(),this.display()}))}editTagStyle(t,e){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Edit Tag Style"});let s=i.createDiv({cls:"tag-style-form"}),n,a,r;new k.Setting(s).setName("Tag Name").setDesc("Tag name without the # symbol").addText(l=>{n=l.inputEl,l.setValue(e.tag)}),new k.Setting(s).setName("Color").setDesc("Choose a color for the timeline point").addColorPicker(l=>{a=l.colorPickerEl,l.setValue(e.color)}),new k.Setting(s).setName("Emoji (Optional)").setDesc("Enter an emoji to display below the timeline point").addText(l=>{r=l.inputEl,l.setValue(e.emoji||"")}),new k.Setting(s).addButton(l=>l.setButtonText("Save").setCta().onClick(async()=>{let c=n.value.trim().toLowerCase(),m=a.value,d=r.value.trim();if(!c){alert("Please enter a tag name");return}let u=this.plugin.settings.tagStyles.findIndex(h=>h.tag===c);if(u!==-1&&u!==t){alert(`A style for tag "${c}" already exists`);return}this.plugin.settings.tagStyles[t]={tag:c,color:m,emoji:d},await this.plugin.saveSettings(),this.display()})).addButton(l=>l.setButtonText("Cancel").onClick(()=>{this.display()}))}};var A=class{constructor(o){g(this,"vault");this.vault=o}async getAvailableMonths(o,t){let e=new Set,i=this.vault.getMarkdownFiles();for(let s of i)if(this.isInDailyNotesFolder(s.path,o)){let n=this.extractDateFromFilename(s.name,t);if(n){let a=this.parseDate(n);if(a){let r=`${a.getFullYear()}-${a.getMonth()}`;e.add(r)}}}return Array.from(e).sort()}async parseDailyNotes(o,t,e,i){let s=new Map,n=this.vault.getMarkdownFiles();for(let l of n)if(this.isInDailyNotesFolder(l.path,o)){let c=this.extractDateFromFilename(l.name,t);if(c){let m=this.parseDate(c);if(m&&m>=e&&m<=i){let d=await this.extractTasks(l);s.set(c,{date:c,path:l.path,tasks:d})}}}let a=this.getAllDatesInRange(e,i),r=[];for(let l of a)s.has(l)?r.push(s.get(l)):r.push({date:l,path:"",tasks:[]});return r}getAllDatesInRange(o,t){let e=[],i=new Date(o);for(;i<=t;){let s=i.getFullYear(),n=String(i.getMonth()+1).padStart(2,"0"),a=String(i.getDate()).padStart(2,"0");e.push(`${s}-${n}-${a}`),i.setDate(i.getDate()+1)}return e}isInDailyNotesFolder(o,t){return t?o.startsWith(t):!0}extractDateFromFilename(o,t){let e=o.replace(/\.md$/,"");if(t==="YYYY-MM-DD"){let i=e.match(/(\d{4}-\d{2}-\d{2})/);return i?i[1]:null}return e}parseDate(o){try{let[t,e,i]=o.split("-").map(Number);return new Date(t,e-1,i)}catch(t){return null}}extractFirstTag(o){let t=/#([\p{L}\p{N}_/-]+)/u,e=o.match(t);return e?e[1].toLowerCase():void 0}hasImageAttachment(o){return/!\[\[.*?\.(png|jpg|jpeg|gif|webp|bmp|svg)\]\]|!\[.*?\]\(.*?\.(png|jpg|jpeg|gif|webp|bmp|svg)\)/i.test(o)}async extractTasks(o){let e=(await this.vault.cachedRead(o)).split(`
`),i=[],s=null,n=/^- \[([^\]]+)\]\s+\*(\d{2}:\d{2})(?:-(\d{2}:\d{2}))?\*\s+(.+)$/;for(let a=0;a<e.length;a++){let r=e[a],l=r.match(n);if(l){s&&(this.finalizeTask(s),i.push(s));let[,c,m,d,u]=l,[h,p]=m.split(":").map(Number),D=this.extractFirstTag(u),f=!!d,v,T;f&&d&&([v,T]=d.split(":").map(Number)),s={status:c,time:m,content:u.trim(),subItems:[],date:this.extractDateFromFilename(o.name,"YYYY-MM-DD")||"",hour:h,minute:p,firstTag:D,hasAttachment:!1,isTimeRange:f,timeEnd:d,endHour:v,endMinute:T}}else s&&r.trim().startsWith("-")&&r.includes("	")?s.subItems.push(r.trim().substring(1).trim()):s&&!r.trim().startsWith("-")&&r.trim()!==""&&s&&(this.finalizeTask(s),i.push(s),s=null)}return s&&(this.finalizeTask(s),i.push(s)),i}finalizeTask(o){if(o.hasAttachment=this.hasImageAttachment(o.content),!o.hasAttachment){for(let t of o.subItems)if(this.hasImageAttachment(t)){o.hasAttachment=!0;break}}}};var Z={dailyNotesFolder:"",dateFormat:"YYYY-MM-DD",defaultRangeMonths:1,tagStyles:[],enableGrouping:!0,minSpacingPixels:25,maxGroupSpanPixels:60,viewMode:"month",customStartDate:"",customEndDate:"",lastQuickRangePreset:"custom"};var j=class{parseConfig(o){let t=o.trim().split(`
`),e={};for(let i of t){let s=i.trim();if(!s||s.startsWith("#"))continue;let n=s.indexOf(":");if(n===-1)continue;let a=s.substring(0,n).trim(),r=s.substring(n+1).trim();switch(a){case"mode":if(r==="month"||r==="custom")e.mode=r;else return{error:`Invalid mode: "${r}". Must be "month" or "custom".`};break;case"startDate":e.startDate=r;break;case"endDate":e.endDate=r;break;case"show":if(e.show=this.parseQuickRangePreset(r),!e.show)return{error:`Invalid show preset: "${r}". Valid options: last-7, last-30, this-week, this-month, last-3m.`};break}}if(!e.mode)return{error:'Missing required parameter: "mode". Must specify "month" or "custom".'};if(e.mode==="month"&&e.startDate&&!this.parseDate(e.startDate))return{error:`Invalid startDate format: "${e.startDate}". Expected format: DD.MM.YYYY or YYYY-MM-DD.`};if(e.mode==="custom")if(e.show){if(e.startDate||e.endDate)return{error:'Cannot use "show" preset with explicit startDate/endDate. Use either "show" or explicit dates, not both.'}}else{if(!e.startDate||!e.endDate)return{error:'Custom mode requires either "show" preset or both "startDate" and "endDate".'};let i=this.parseDate(e.startDate),s=this.parseDate(e.endDate);if(!i)return{error:`Invalid startDate format: "${e.startDate}". Expected format: DD.MM.YYYY or YYYY-MM-DD.`};if(!s)return{error:`Invalid endDate format: "${e.endDate}". Expected format: DD.MM.YYYY or YYYY-MM-DD.`};if(s<i)return{error:`endDate (${e.endDate}) must be after or equal to startDate (${e.startDate}).`};let n=Math.ceil((s.getTime()-i.getTime())/(1e3*60*60*24));if(n>365)return{error:`Date range cannot exceed 365 days. Current range: ${n} days.`}}return e}parseQuickRangePreset(o){return{"last-7":"last7days","last-30":"last30days","this-week":"thisweek","this-month":"thismonth","last-3m":"last3months"}[o]||null}parseDate(o){if(o.includes(".")){let t=o.split(".");if(t.length===3){let e=parseInt(t[0],10),i=parseInt(t[1],10),s=parseInt(t[2],10);if(!isNaN(e)&&!isNaN(i)&&!isNaN(s))return new Date(s,i-1,e)}}else if(o.includes("-")){let t=o.split("-");if(t.length===3){let e=parseInt(t[0],10),i=parseInt(t[1],10),s=parseInt(t[2],10);if(!isNaN(e)&&!isNaN(i)&&!isNaN(s))return new Date(e,i-1,s)}}return null}calculateDateRange(o){if(o.mode==="month"){if(o.startDate){let a=this.parseDate(o.startDate);if(a){let r=new Date(a.getFullYear(),a.getMonth(),1),l=new Date(a.getFullYear(),a.getMonth()+1,0);return{startDate:r,endDate:l}}}let i=new Date,s=new Date(i.getFullYear(),i.getMonth(),1),n=new Date(i.getFullYear(),i.getMonth()+1,0);return{startDate:s,endDate:n}}if(o.show)return this.calculateQuickRangePreset(o.show);let t=this.parseDate(o.startDate),e=this.parseDate(o.endDate);return{startDate:t,endDate:e}}calculateQuickRangePreset(o){let t=new Date;t.setHours(0,0,0,0);let e,i;switch(o){case"last7days":i=new Date(t),e=new Date(t),e.setDate(e.getDate()-6);break;case"last30days":i=new Date(t),e=new Date(t),e.setDate(e.getDate()-29);break;case"thisweek":let s=t.getDay();e=new Date(t),e.setDate(e.getDate()-s),i=new Date(e),i.setDate(i.getDate()+6);break;case"thismonth":e=new Date(t.getFullYear(),t.getMonth(),1),i=new Date(t.getFullYear(),t.getMonth()+1,0);break;case"last3months":i=new Date(t),e=new Date(t),e.setMonth(e.getMonth()-3);break;default:e=new Date(t.getFullYear(),t.getMonth(),1),i=new Date(t.getFullYear(),t.getMonth()+1,0)}return{startDate:e,endDate:i}}};var w={MIN:.7,MAX:10,DEFAULT:1,STEP:.5,BASE_SEGMENT_WIDTH:200},Y=class{constructor(o,t,e){g(this,"plugin");g(this,"container");g(this,"config");g(this,"initialStartDate");g(this,"initialEndDate");g(this,"currentStartDate");g(this,"currentEndDate");g(this,"zoomLevel",w.DEFAULT);g(this,"tooltips",[]);g(this,"timelineContainerEl",null);g(this,"isDragging",!1);g(this,"dragStartX",0);g(this,"dragStartScrollLeft",0);g(this,"zoomSlider",null);g(this,"zoomLabel",null);g(this,"configParser");g(this,"currentViewMode","custom");g(this,"monthSelectEl",null);g(this,"quickSelectEl",null);g(this,"customStartDateInputEl",null);g(this,"customEndDateInputEl",null);g(this,"viewModeContainerEl",null);this.plugin=o,this.container=t,this.config=e,this.configParser=new j;let i=this.configParser.calculateDateRange(e);this.initialStartDate=i.startDate,this.initialEndDate=i.endDate,this.currentStartDate=new Date(this.initialStartDate),this.currentEndDate=new Date(this.initialEndDate)}async render(){this.container.empty(),this.container.addClass("embedded-timeline-container"),await this.renderControls(),await this.renderTimeline()}destroy(){this.cleanupTooltips(),this.container.empty()}cleanupTooltips(){for(let o of this.tooltips)o.remove();this.tooltips=[]}async renderControls(){let o=this.container.createDiv({cls:"embedded-timeline-controls"}),t=o.createDiv({cls:"embedded-timeline-controls-row"}),e=o.createDiv({cls:"embedded-timeline-controls-row"}),i=t.createDiv({cls:"embedded-timeline-nav-group"});i.createEl("button",{text:"\u2190",cls:"mod-cta embedded-timeline-btn-compact",attr:{"aria-label":"Previous"}}).addEventListener("click",async()=>{await this.navigatePrevious()}),i.createEl("button",{text:"Today",cls:"mod-cta embedded-timeline-btn-compact"}).addEventListener("click",async()=>{await this.navigateToToday()}),i.createEl("button",{text:"\u2192",cls:"mod-cta embedded-timeline-btn-compact",attr:{"aria-label":"Next"}}).addEventListener("click",async()=>{await this.navigateNext()}),this.renderZoomControls(t),t.createEl("button",{text:"Reset",cls:"mod-warning embedded-timeline-btn-compact"}).addEventListener("click",async()=>{await this.resetToInitial()}),this.renderViewModeSelector(e)}formatDateDisplay(o){return o.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}formatDateForInput(o){let t=o.getFullYear(),e=String(o.getMonth()+1).padStart(2,"0"),i=String(o.getDate()).padStart(2,"0");return`${t}-${e}-${i}`}async renderViewModeSelector(o){let t=o.createDiv({cls:"embedded-timeline-view-mode"});this.viewModeContainerEl=t;let e=t.createEl("select",{cls:"embedded-timeline-select-compact"});e.createEl("option",{value:"month",text:"Month"}),e.createEl("option",{value:"custom",text:"Custom"}),e.value=this.currentViewMode,e.addEventListener("change",async()=>{this.currentViewMode=e.value,this.updateViewModeControls()});let s=t.createDiv({cls:"embedded-timeline-month-picker"}).createEl("select",{cls:"embedded-timeline-select-compact"});this.monthSelectEl=s,await this.populateMonthSelect(s),s.addEventListener("change",async()=>{let[d,u]=s.value.split("-").map(Number);this.currentStartDate=new Date(d,u,1),this.currentEndDate=new Date(d,u+1,0),this.zoomLevel=w.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()});let n=t.createDiv({cls:"embedded-timeline-custom-picker"}),a=n.createEl("select",{cls:"embedded-timeline-select-compact"});this.quickSelectEl=a,a.createEl("option",{value:"custom",text:"Custom dates"}),a.createEl("option",{value:"last7days",text:"Last 7 days"}),a.createEl("option",{value:"last30days",text:"Last 30 days"}),a.createEl("option",{value:"thisweek",text:"This week"}),a.createEl("option",{value:"thismonth",text:"This month"}),a.createEl("option",{value:"last3months",text:"Last 3 months"}),a.value="custom",a.addEventListener("change",async()=>{let d=a.value;d!=="custom"&&this.applyQuickRangePreset(d)});let r=n.createDiv({cls:"embedded-timeline-date-pickers"}),l=r.createEl("input",{type:"date",cls:"embedded-timeline-date-input-compact"});this.customStartDateInputEl=l,l.value=this.formatDateForInput(this.currentStartDate);let c=r.createSpan({cls:"embedded-timeline-date-separator",text:"\u2014"}),m=r.createEl("input",{type:"date",cls:"embedded-timeline-date-input-compact"});this.customEndDateInputEl=m,m.value=this.formatDateForInput(this.currentEndDate),l.addEventListener("change",async()=>{await this.handleCustomDateChange()}),m.addEventListener("change",async()=>{await this.handleCustomDateChange()}),this.updateViewModeControls()}async handleCustomDateChange(){if(!this.customStartDateInputEl||!this.customEndDateInputEl)return;let o=this.customStartDateInputEl.value,t=this.customEndDateInputEl.value;if(!o||!t)return;let e=new Date(o),i=new Date(t);if(i<e){this.customStartDateInputEl.value=this.formatDateForInput(this.currentStartDate),this.customEndDateInputEl.value=this.formatDateForInput(this.currentEndDate);return}if(Math.ceil((i.getTime()-e.getTime())/(1e3*60*60*24))>365){this.customStartDateInputEl.value=this.formatDateForInput(this.currentStartDate),this.customEndDateInputEl.value=this.formatDateForInput(this.currentEndDate);return}this.currentStartDate=e,this.currentEndDate=i,this.quickSelectEl&&(this.quickSelectEl.value="custom"),this.zoomLevel=w.DEFAULT,await this.renderTimeline(),this.updateZoomSlider()}applyQuickRangePreset(o){let t=new Date;t.setHours(0,0,0,0);let e,i;switch(o){case"last7days":i=new Date(t),e=new Date(t),e.setDate(e.getDate()-6);break;case"last30days":i=new Date(t),e=new Date(t),e.setDate(e.getDate()-29);break;case"thisweek":let s=t.getDay();e=new Date(t),e.setDate(e.getDate()-s),i=new Date(e),i.setDate(i.getDate()+6);break;case"thismonth":e=new Date(t.getFullYear(),t.getMonth(),1),i=new Date(t.getFullYear(),t.getMonth()+1,0);break;case"last3months":i=new Date(t),e=new Date(t),e.setMonth(e.getMonth()-3);break;default:return}this.currentStartDate=e,this.currentEndDate=i,this.customStartDateInputEl&&this.customEndDateInputEl&&(this.customStartDateInputEl.value=this.formatDateForInput(e),this.customEndDateInputEl.value=this.formatDateForInput(i)),this.zoomLevel=w.DEFAULT,this.renderTimeline(),this.updateZoomSlider()}updateViewModeControls(){if(!this.monthSelectEl||!this.customStartDateInputEl||!this.customEndDateInputEl)return;let o=this.monthSelectEl.parentElement,t=this.customStartDateInputEl.parentElement;this.currentViewMode==="month"?(o&&(o.style.display="flex"),t&&(t.style.display="none")):(o&&(o.style.display="none"),t&&(t.style.display="flex"))}async populateMonthSelect(o){let t=await this.plugin.parser.getAvailableMonths(this.plugin.settings.dailyNotesFolder,this.plugin.settings.dateFormat);o.empty();for(let e of t){let[i,s]=e.split("-").map(Number),n=new Date(i,s,1),a=o.createEl("option");a.value=e,a.text=n.toLocaleDateString("en-US",{year:"numeric",month:"short"}),i===this.currentStartDate.getFullYear()&&s===this.currentStartDate.getMonth()&&(a.selected=!0)}}renderZoomControls(o){let t=o.createDiv({cls:"embedded-timeline-zoom-controls"}),e=t.createDiv({cls:"embedded-timeline-zoom-icon",attr:{"aria-label":"Zoom out"}});e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path><line x1="8" y1="11" x2="14" y2="11"></line></svg>',e.addEventListener("click",()=>{let a=Math.max(w.MIN,this.zoomLevel-w.STEP);this.applyZoom(a)});let i=t.createEl("input",{type:"range",cls:"embedded-timeline-zoom-slider"});i.min=String(w.MIN*100),i.max=String(w.MAX*100),i.value=String(this.zoomLevel*100),i.step=String(w.STEP*100);let s=t.createDiv({cls:"embedded-timeline-zoom-label"});s.setText(`${Math.round(this.zoomLevel*100)}%`);let n=t.createDiv({cls:"embedded-timeline-zoom-icon",attr:{"aria-label":"Zoom in"}});n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>',n.addEventListener("click",()=>{let a=Math.min(w.MAX,this.zoomLevel+w.STEP);this.applyZoom(a)}),i.addEventListener("input",()=>{let a=parseFloat(i.value)/100;s.setText(`${Math.round(a*100)}%`)}),i.addEventListener("change",()=>{let a=parseFloat(i.value)/100;this.applyZoom(a)}),this.zoomSlider=i,this.zoomLabel=s}updateZoomSlider(){this.zoomSlider&&(this.zoomSlider.value=String(this.zoomLevel*100)),this.zoomLabel&&this.zoomLabel.setText(`${Math.round(this.zoomLevel*100)}%`)}applyZoom(o,t){if(!this.timelineContainerEl)return;let e=this.timelineContainerEl,i=e.scrollLeft,s=e.clientWidth,n=e.scrollWidth,a;t!==void 0?a=i+t:a=i+s/2;let r=a/n;this.zoomLevel=o,this.updateZoomSlider(),this.renderTimeline().then(()=>{if(!this.timelineContainerEl)return;let l=this.timelineContainerEl.scrollWidth,c=r*l,m=t!==void 0?c-t:c-s/2;this.timelineContainerEl.scrollLeft=Math.max(0,m)})}getRangeDurationInDays(){let o=Math.abs(this.currentEndDate.getTime()-this.currentStartDate.getTime());return Math.ceil(o/(1e3*60*60*24))+1}async navigatePrevious(){let o=this.getRangeDurationInDays();this.currentStartDate.setDate(this.currentStartDate.getDate()-o),this.currentEndDate.setDate(this.currentEndDate.getDate()-o),this.zoomLevel=w.DEFAULT,await this.render()}async navigateNext(){let o=this.getRangeDurationInDays();this.currentStartDate.setDate(this.currentStartDate.getDate()+o),this.currentEndDate.setDate(this.currentEndDate.getDate()+o),this.zoomLevel=w.DEFAULT,await this.render()}async navigateToToday(){let o=new Date;this.currentStartDate=new Date(o.getFullYear(),o.getMonth(),1),this.currentEndDate=new Date(o.getFullYear(),o.getMonth()+1,0),this.zoomLevel=w.DEFAULT,await this.render()}async resetToInitial(){this.currentStartDate=new Date(this.initialStartDate),this.currentEndDate=new Date(this.initialEndDate),this.zoomLevel=w.DEFAULT,await this.render()}async renderTimeline(){this.cleanupTooltips();let o=this.container.querySelector(".embedded-timeline-scroll");o&&o.remove();let t=this.container.createDiv({cls:"embedded-timeline-scroll"}),e=await this.plugin.parser.parseDailyNotes(this.plugin.settings.dailyNotesFolder,this.plugin.settings.dateFormat,this.currentStartDate,this.currentEndDate);if(e.length===0){t.createDiv({cls:"timeline-empty",text:"No daily notes found in this date range"});return}await this.renderContinuousTimeline(t,e)}async renderContinuousTimeline(o,t){let e=o.createDiv({cls:"timeline-continuous"});this.timelineContainerEl=e,this.setupTimelineInteractions(e);let i=e.createDiv({cls:"timeline-track-continuous"}),s=w.BASE_SEGMENT_WIDTH*this.zoomLevel,n=s*t.length;i.style.width=`${n}px`;for(let a=0;a<t.length;a++){let r=t[a];await this.renderDaySegment(i,r,a,t.length,s)}}setupTimelineInteractions(o){o.addEventListener("wheel",i=>{if(i.ctrlKey||i.metaKey){i.preventDefault();let s=o.getBoundingClientRect(),n=i.clientX-s.left,r=-i.deltaY>0?w.STEP:-w.STEP,l=Math.max(w.MIN,Math.min(w.MAX,this.zoomLevel+r));this.applyZoom(l,n)}else i.preventDefault(),o.scrollLeft+=i.deltaY}),o.addEventListener("mousedown",i=>{if(i.button!==0)return;let s=i.target;s.closest(".timeline-task")||s.closest("a")||(i.preventDefault(),this.isDragging=!0,this.dragStartX=i.clientX,this.dragStartScrollLeft=o.scrollLeft,o.style.cursor="grabbing",o.style.userSelect="none")});let t=i=>{if(!this.isDragging||!this.timelineContainerEl)return;i.preventDefault();let s=i.clientX-this.dragStartX;this.timelineContainerEl.scrollLeft=this.dragStartScrollLeft-s},e=()=>{this.isDragging&&this.timelineContainerEl&&(this.isDragging=!1,this.timelineContainerEl.style.cursor="grab",this.timelineContainerEl.style.userSelect="")};document.addEventListener("mousemove",t),document.addEventListener("mouseup",e),o.addEventListener("mouseleave",()=>{this.isDragging&&this.timelineContainerEl&&(this.isDragging=!1,this.timelineContainerEl.style.cursor="grab",this.timelineContainerEl.style.userSelect="")})}groupOverlappingTasks(o,t){if(o.length===0)return[];if(!this.plugin.settings.enableGrouping)return o;let i=[...o.filter(l=>!l.isTimeRange)].sort((l,c)=>{let m=l.hour*60+l.minute,d=c.hour*60+c.minute;return m-d}),s=this.plugin.settings.minSpacingPixels,n=this.plugin.settings.maxGroupSpanPixels,a=[],r=[i[0]];for(let l=1;l<i.length;l++){let c=i[l-1],m=i[l],d=(c.hour*60+c.minute)/1440*100,u=(m.hour*60+m.minute)/1440*100,h=Math.abs(u-d)*(t/100),p=(r[0].hour*60+r[0].minute)/1440*100,D=Math.abs(u-p)*(t/100);if(h<s&&D<n)r.push(m);else{if(r.length>1){let f=r.reduce((y,C)=>y+(C.hour*60+C.minute),0)/r.length,v=f/1440*100,T=Math.floor(f/60),E=Math.floor(f%60);a.push({tasks:r,position:v,averageTime:`${String(T).padStart(2,"0")}:${String(E).padStart(2,"0")}`})}else a.push(r[0]);r=[m]}}if(r.length>1){let l=r.reduce((u,h)=>u+(h.hour*60+h.minute),0)/r.length,c=l/1440*100,m=Math.floor(l/60),d=Math.floor(l%60);a.push({tasks:r,position:c,averageTime:`${String(m).padStart(2,"0")}:${String(d).padStart(2,"0")}`})}else a.push(r[0]);return a}async renderDaySegment(o,t,e,i,s){let n=o.createDiv({cls:"timeline-segment"});n.style.width=`${s}px`,n.style.left=`${s*e}px`,t.tasks.length===0&&n.addClass("timeline-segment-empty");let a=new Date(t.date),r=n.createDiv({cls:"timeline-segment-date"});r.setText(a.toLocaleDateString("en-US",{month:"short",day:"numeric"})),t.path&&(r.addClass("timeline-segment-date-clickable"),r.addEventListener("click",async h=>{h.preventDefault();let p=this.plugin.app.vault.getAbstractFileByPath(t.path);p&&await this.plugin.app.workspace.getLeaf(!1).openFile(p)})),n.createDiv({cls:"timeline-segment-weekday"}).setText(a.toLocaleDateString("en-US",{weekday:"short"})),n.createDiv({cls:"timeline-segment-time timeline-segment-time-start"}).setText("00:00"),n.createDiv({cls:"timeline-segment-time timeline-segment-time-end"}).setText("23:59");let d=this.groupOverlappingTasks(t.tasks,s);for(let h of d)"tasks"in h?await this.renderGroupedTaskInSegment(n,h):await this.renderTaskInSegment(n,h);let u=F.detectOverlaps(t.tasks);for(let h of u)await this.renderTimeRangeInSegment(n,h,s)}getTagStyle(o){return o?this.plugin.settings.tagStyles.find(t=>t.tag===o):null}async renderGroupedTaskInSegment(o,t){let e=o.createDiv({cls:"timeline-task-dot-container timeline-task-grouped"}),i=Math.min(t.position,96);e.style.left=`${i}%`;let s=e.createDiv({cls:"timeline-task-dot"});s.setAttribute("data-status","grouped"),s.createDiv({cls:"timeline-task-count-badge"}).setText(String(t.tasks.length));let a=e.createDiv({cls:"timeline-emoji-stack"}),r=new Set;for(let m of t.tasks){let d=this.getTagStyle(m.firstTag);d&&d.emoji?r.add(d.emoji):m.hasAttachment&&!r.has("\u{1F4F8}")&&r.add("\u{1F4F8}")}r.forEach(m=>{a.createDiv({cls:"timeline-task-emoji"}).setText(m)});let l=document.body.createDiv({cls:"timeline-tooltip"});this.tooltips.push(l);let c=l.createDiv({cls:"timeline-tooltip-wrapper"});for(let m=0;m<t.tasks.length;m++){let d=t.tasks[m],u=c.createDiv({cls:"timeline-tooltip-content"});m>0&&u.addClass("timeline-tooltip-stacked");let h=u.createDiv({cls:"timeline-tooltip-time"}),p=this.getTagStyle(d.firstTag);p&&p.emoji&&h.createSpan({cls:"timeline-tooltip-time-emoji"}).setText(p.emoji),h.createSpan().setText(d.time);let f=u.createDiv({cls:"timeline-tooltip-task"});if(f.textContent=`[${d.status}] `,await this.renderTaskContent(f,d.content),d.subItems.length>0){let v=u.createEl("ul",{cls:"timeline-tooltip-subitems"});for(let T of d.subItems){let E=v.createEl("li");await this.renderTaskContent(E,T)}}}e.addEventListener("mouseenter",()=>{let m=e.getBoundingClientRect(),d=window.innerHeight,u=t.tasks.length*120,h=m.bottom+12,p=m.left+m.width/2,D="translateX(-50%)",f=!1;h+u>d-20&&d-h-20<200&&(h=m.top-Math.min(u,d*.6)-12,f=!0,h<20&&(h=20));let v=Math.min(d*.7,u);c.style.maxHeight=`${v}px`,f?l.addClass("tooltip-above"):l.removeClass("tooltip-above"),l.style.top=`${h}px`,l.style.left=`${p}px`,l.style.transform=D,l.addClass("is-visible"),e.addClass("is-hovered")}),e.addEventListener("mouseleave",()=>{l.removeClass("is-visible"),l.removeClass("tooltip-above"),e.removeClass("is-hovered")}),l.addEventListener("mouseenter",()=>{l.addClass("is-visible"),e.addClass("is-hovered")}),l.addEventListener("mouseleave",()=>{l.removeClass("is-visible"),l.removeClass("tooltip-above"),e.removeClass("is-hovered")})}async renderTaskInSegment(o,t){let i=(t.hour*60+t.minute)/1440*100;i=Math.min(i,96);let s=o.createDiv({cls:"timeline-task-dot-container"});s.style.left=`${i}%`;let n=s.createDiv({cls:"timeline-task-dot"});n.setAttribute("data-status",t.status);let a=this.getTagStyle(t.firstTag);a&&a.color&&(n.addClass("timeline-task-dot-custom"),n.style.setProperty("background-color",a.color,"important")),n.createDiv({cls:"timeline-task-label"}).setText(t.time);let l=s.createDiv({cls:"timeline-emoji-stack"});a&&a.emoji?l.createDiv({cls:"timeline-task-emoji"}).setText(a.emoji):t.hasAttachment&&l.createDiv({cls:"timeline-task-emoji"}).setText("\u{1F4F8}");let c=document.body.createDiv({cls:"timeline-tooltip"});this.tooltips.push(c);let m=c.createDiv({cls:"timeline-tooltip-content"}),d=m.createDiv({cls:"timeline-tooltip-time"});a&&a.emoji&&d.createSpan({cls:"timeline-tooltip-time-emoji"}).setText(a.emoji),d.createSpan().setText(t.time);let h=m.createDiv({cls:"timeline-tooltip-task"});if(h.textContent=`[${t.status}] `,await this.renderTaskContent(h,t.content),t.subItems.length>0){let p=m.createEl("ul",{cls:"timeline-tooltip-subitems"});for(let D of t.subItems){let f=p.createEl("li");await this.renderTaskContent(f,D)}}s.addEventListener("mouseenter",()=>{let p=s.getBoundingClientRect(),D=window.innerHeight,f=p.bottom+12;setTimeout(()=>{let v=c.offsetHeight;f+v>D-20?(f=p.top-v-12,c.addClass("tooltip-above"),f<20&&(f=20)):c.removeClass("tooltip-above"),c.style.top=`${f}px`},0),c.style.top=`${f}px`,c.style.left=`${p.left+p.width/2}px`,c.style.transform="translateX(-50%)",c.addClass("is-visible"),s.addClass("is-hovered")}),s.addEventListener("mouseleave",()=>{c.removeClass("is-visible"),c.removeClass("tooltip-above"),s.removeClass("is-hovered")}),c.addEventListener("mouseenter",()=>{c.addClass("is-visible"),s.addClass("is-hovered")}),c.addEventListener("mouseleave",()=>{c.removeClass("is-visible"),c.removeClass("tooltip-above"),s.removeClass("is-hovered")})}async renderTimeRangeInSegment(o,t,e){let i=t.task;if(!i.endHour||i.endMinute===void 0)return;let s=i.hour*60+i.minute,n=i.endHour*60+i.endMinute,a=Math.min(s/1440*100,96),l=Math.min(n/1440*100,100)-a,c=o.createDiv({cls:"timeline-range-container"});c.style.left=`${a}%`,c.style.width=`${l}%`;let m=t.overlapLevel===0?0:t.overlapLevel*40;c.style.bottom=`calc(50% + ${m}px)`,c.setAttribute("data-overlap-level",String(t.overlapLevel));let d=c.createDiv({cls:"timeline-range-line"});d.setAttribute("data-status",i.status);let u=this.getTagStyle(i.firstTag);u&&u.color&&(d.addClass("timeline-range-line-custom"),d.style.setProperty("background-color",u.color,"important"));let h=l/100*e,p=`${i.time} - ${i.timeEnd}`,D=p.length*6,f=h>=D+10,v;f?(v=d.createDiv({cls:"timeline-range-label timeline-range-label-inside"}),v.setText(p)):(v=c.createDiv({cls:"timeline-range-label timeline-range-label-outside"}),v.setText(p));let T=c.createDiv({cls:"timeline-range-emoji"});u&&u.emoji?T.createDiv({cls:"timeline-task-emoji"}).setText(u.emoji):i.hasAttachment&&T.createDiv({cls:"timeline-task-emoji"}).setText("\u{1F4F8}");let E=document.body.createDiv({cls:"timeline-tooltip"});this.tooltips.push(E);let y=E.createDiv({cls:"timeline-tooltip-content"}),C=y.createDiv({cls:"timeline-tooltip-time"});u&&u.emoji&&C.createSpan({cls:"timeline-tooltip-time-emoji"}).setText(u.emoji),C.createSpan().setText(`${i.time} - ${i.timeEnd}`);let B=y.createDiv({cls:"timeline-tooltip-task"});if(B.textContent=`[${i.status}] `,await this.renderTaskContent(B,i.content),i.subItems.length>0){let M=y.createEl("ul",{cls:"timeline-tooltip-subitems"});for(let L of i.subItems){let x=M.createEl("li");await this.renderTaskContent(x,L)}}c.addEventListener("mouseenter",()=>{let M=c.getBoundingClientRect(),L=window.innerHeight,x=M.bottom+12;setTimeout(()=>{let I=E.offsetHeight;x+I>L-20?(x=M.top-I-12,E.addClass("tooltip-above"),x<20&&(x=20)):E.removeClass("tooltip-above"),E.style.top=`${x}px`},0),E.style.top=`${x}px`,E.style.left=`${M.left+M.width/2}px`,E.style.transform="translateX(-50%)",E.addClass("is-visible"),c.addClass("is-hovered")}),c.addEventListener("mouseleave",()=>{E.removeClass("is-visible"),E.removeClass("tooltip-above"),c.removeClass("is-hovered")}),E.addEventListener("mouseenter",()=>{E.addClass("is-visible"),c.addClass("is-hovered")}),E.addEventListener("mouseleave",()=>{E.removeClass("is-visible"),E.removeClass("tooltip-above"),c.removeClass("is-hovered")})}async renderTaskContent(o,t){let e=/(!\[\[([^\]]+)\]\])|(\[\[([^\]]+)\]\])/g,i=0,s;for(;(s=e.exec(t))!==null;){if(s.index>i&&await this.renderTextWithLinks(o,t.substring(i,s.index)),s[1]){let n=s[2];await this.renderImage(o,n)}else if(s[3]){let n=s[4];this.renderLink(o,n)}i=s.index+s[0].length}i<t.length&&await this.renderTextWithLinks(o,t.substring(i))}async renderTextWithLinks(o,t){let e=/#([\p{L}\p{N}_\/-]+)/gu,i=0,s;for(;(s=e.exec(t))!==null;){if(s.index>i){let r=o.createSpan();r.textContent=t.substring(i,s.index)}let n=s[1],a=o.createEl("a",{cls:"tag timeline-tooltip-tag",href:"#"});a.textContent=`#${n}`,a.addEventListener("click",async r=>{var l;r.preventDefault(),(l=this.plugin.app.internalPlugins.getPluginById("global-search"))==null||l.instance.openGlobalSearch(`tag:#${n}`)}),i=s.index+s[0].length}if(i<t.length){let n=o.createSpan();n.textContent=t.substring(i)}}renderLink(o,t){let e=t.split("|"),i=e[0].trim(),s=e.length>1?e[1].trim():i,n=o.createEl("a",{cls:"internal-link timeline-tooltip-link",href:"#"});n.textContent=s,n.addEventListener("click",async a=>{a.preventDefault();let r=this.plugin.app.metadataCache.getFirstLinkpathDest(i,"");r&&await this.plugin.app.workspace.getLeaf(!1).openFile(r)})}async renderImage(o,t){let e=this.plugin.app.vault.getAbstractFileByPath(t);if(e&&e instanceof this.plugin.app.vault.adapter.constructor){let s=o.createDiv({cls:"timeline-tooltip-image"}).createEl("img"),n=this.plugin.app.vault.getResourcePath(e);s.src=n,s.alt=t}else{let s=this.plugin.app.vault.getFiles().find(n=>n.name===t||n.path.endsWith(t));if(s){let a=o.createDiv({cls:"timeline-tooltip-image"}).createEl("img"),r=this.plugin.app.vault.getResourcePath(s);a.src=r,a.alt=t}}}};var z=class extends V.Plugin{constructor(){super(...arguments);g(this,"settings");g(this,"parser");g(this,"embeddedTimelines",new Map)}async onload(){await this.loadSettings(),this.parser=new A(this.app.vault),this.registerView(H,t=>new N(t,this)),this.addRibbonIcon("calendar-clock","Open Daily Notes Timeline",()=>{this.activateView()}),this.addCommand({id:"open-timeline-view",name:"Open Daily Notes Timeline",callback:()=>{this.activateView()}}),this.addSettingTab(new $(this.app,this)),this.registerMarkdownCodeBlockProcessor("daily-timeline",this.processTimelineCodeblock.bind(this))}async processTimelineCodeblock(t,e,i){let n=new j().parseConfig(t);if("error"in n){e.createDiv({cls:"embedded-timeline-error",text:`\u26A0\uFE0F Timeline Configuration Error: ${n.error}`});return}let a=this.embeddedTimelines.get(e);a&&(a.destroy(),this.embeddedTimelines.delete(e));let r=new Y(this,e,n);this.embeddedTimelines.set(e,r);try{await r.render()}catch(l){e.createDiv({cls:"embedded-timeline-error",text:`\u26A0\uFE0F Failed to render timeline: ${l.message}`})}}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(H)[0];e||(e=t.getLeaf(!0),await e.setViewState({type:H,active:!0})),t.revealLeaf(e)}async loadSettings(){this.settings=Object.assign({},Z,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}onunload(){this.app.workspace.detachLeavesOfType(H);for(let t of this.embeddedTimelines.values())t.destroy();this.embeddedTimelines.clear()}};
